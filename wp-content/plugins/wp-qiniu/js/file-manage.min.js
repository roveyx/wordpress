jQuery(function(a){a("div.file-on-qiniu").live("click",function(c){a(this).toggleClass("selected");var b=a("div.file-on-qiniu.selected");if(b.length>0){a("#btn-delete").attr("disabled",false);a("#btn-clear").attr("disabled",false)}else{a("#btn-delete").attr("disabled",true);a("#btn-clear").attr("disabled",true)}if(b.length==1){a("#btn-rename").attr("disabled",false)}else{a("#btn-rename").attr("disabled",true)}if(a('div[data-file-type!="dir"].file-on-qiniu.selected').length>0){a("#btn-insert").attr("disabled",false)}else{a("#btn-insert").attr("disabled",true)}});a("#btn-insert").live("click",function(){var b=a('div[data-file-type!="dir"].file-on-qiniu.selected');if(b.length>0){var c=a("#wp-qiniu-storage-domain").val(),e=a("#load-more").attr("data-current-path"),d="";b.each(function(){var k=a(this),l=k.attr("data-file-name"),g=k.attr("data-file-type"),i=k.attr("data-file-mime"),j=e+l;if(g=="image"){var f="";if(a("#wp-qiniu-watermark-style").val()){f=a("#wp-qiniu-style-split-char").val()+a("#wp-qiniu-watermark-style").val()}var h=c+encodeURI(j+f);d+='<a href="'+h+'"><img src="'+h+'" alt="'+l+'" /></a>'}else{if(g=="video"){d+='[qiniuvideo key="'+j+'" width="600" height="400" type="'+i+'"]'}else{if(g=="audio"){d+='[qiniuaudio key="'+j+'" titles="'+l+'" artists="" autostart="no" loop="no" type="'+i+'"]'}else{d+='[qiniufile key="'+j+'" name="'+l+'" type="'+i+'"]'}}}});b.removeClass("selected");window.parent.send_to_editor(d);window.parent.tb_remove()}else{alert("请选择要插入的文件！")}});a("#btn-close").click(function(){window.parent.tb_remove()});a("#btn-clear").click(function(){var b=a("div.file-on-qiniu.selected");b.removeClass("selected");a("#btn-delete").attr("disabled",true);a("#btn-clear").attr("disabled",true);a("#btn-insert").attr("disabled",true);a("#btn-rename").attr("disabled",true)});a("#btn-reload").click(function(){a("#files-on-qiniu").empty();a("#btn-clear").click();var b=a("#load-more");b.attr("data-paged",1);b.attr("data-loading","false");b.attr("class","page-navi");b.text("加载更多");b.click()});a("#show-upload-area").toggle(function(b){b.preventDefault();a("#files-on-qiniu,#load-more,#prev-page,#manage-buttons").hide();a("#upload-to-qiniu-area").show();a("#wp-qiniu-path-navi").find("a").attr("class","link-Disabled");a(this).text("返回列表")},function(c){c.preventDefault();a("#upload-to-qiniu-area").hide();var b=a("#wp-qiniu-path-navi");b.find("a").attr("class","link-Active");b.find("a:last").attr("class","link-Disabled");a("#files-on-qiniu,#load-more,#prev-page,#manage-buttons").show();a(this).text("上传到这里")});a("#load-more").live("click",function(i){i.preventDefault();var h=a(this),j=h.attr("data-loading"),d=h.attr("data-pid"),g=h.attr("data-paged"),f=h.attr("data-pagesize"),c=h.attr("data-current-path"),b=h.attr("timer-int");if(j=="true"){return}if(b!="undefined"){clearInterval(b)}a.ajax({type:"POST",dataType:"json",url:a("#wp-admin-ajax-url").val(),data:{action:"wp_qiniu_list_files",pid:d,paged:g,pagesize:f,orderby:a('input[name="wp-qiniu-file-orderby"]:checked').val(),nonce:a("#wp_qiniu_ajax_nonce").val()},beforeSend:function(){h.attr("class","page-navi-disable");h.attr("data-loading","true");h.text("正在加载");function e(){var k=h.text();if(k.length<14&&k.length>=4){h.text(k+" .")}else{h.text("正在加载 .")}}b=setInterval(e,1000);h.attr("timer-int",b)},success:function(C,m){clearInterval(b);if(C.status!="success"){alert(C.status);h.attr("data-loading","false");h.text("加载失败！点击后重新加载。Error："+C.error);h.attr("class","page-navi");return}var o=C.data,q=a("#wp-qiniu-storage-domain").val()+encodeURI(h.attr("data-current-path")),r=a("#wp-qiniu-plugin-url").val(),u=a("#wp-qiniu-style-split-char").val()+a("#wp-qiniu-thumbnail-style").val(),l="";for(var z=0;z<o.length;z++){var w=o[z]["id"],t=o[z]["isdir"],B=o[z]["fname"],s=o[z]["fsize"],p=o[z]["ctime"],x=o[z]["width"],v=o[z]["height"],n=o[z]["mimeType"],A=".|jpg|jpeg|png|gif|bmp|",k=".|asf|avi|flv|mkv|mov|mp4|wmv|3gp|3g2|mpeg|ts|rm|rmvb|m3u8|",y=".|ogg|mp3|wma|wav|mp3pro|mid|midi|";if(t==1){l="dir"}else{l=B.substring(B.lastIndexOf(".")+1).toLowerCase()}if(A.indexOf("|"+l+"|")>0){l="image"}else{if(k.indexOf("|"+l+"|")>0){l="video"}else{if(y.indexOf("|"+l+"|")>0){l="audio"}else{if(t==0){l="file"}}}}var e='<div class="file-on-qiniu"'+(l!=="dir"?' title="双击复制连接到剪贴板"':"")+' data-file-name="'+B+'" data-file-type="'+l+'" data-file-id="'+w+'" data-file-mime="'+n+'">';e+='<div class="file-thumbnail">';if(l=="image"){e+='<img src="'+q+encodeURI(B)+u+'" />'}else{e+='<img src="'+r+"img/"+l+'.png" />'}e+="</div>";e+='<div class="file-name"><div class="file-text">';e+=B;e+="</div></div>";e+="</div>";if(c!=h.attr("data-current-path")){return}a("#files-on-qiniu").append(e)}h.attr("data-paged",++g);if(o.length<f){h.attr("data-loading","true");h.text("已全部加载完成");h.attr("class","page-navi-disable")}else{h.attr("data-loading","false");h.text("加载更多");h.attr("class","page-navi")}},error:function(k,m,l){clearInterval(b);h.attr("data-loading","false");h.attr("class","page-navi");if(k.responseText){var e=JSON.parse(k.responseText);h.text("加载失败！点击后重新加载。"+e.error+", "+k.status+": "+l+", status: "+m)}else{h.text("加载失败！点击后重新加载。"+k.status+": "+l+", status: "+m)}},complete:function(e,k){h.removeAttr("timer-int")}})});a(document).ready(function(){a("#load-more").click()});a('div.file-on-qiniu[data-file-type="dir"]').live("dblclick",function(i){a("#btn-clear").click();var h=a(this),b=h.attr("data-file-id"),j=h.attr("data-file-name"),g=a("#load-more"),d=g.attr("data-current-path")+j+"/";g.attr("data-pid",b);g.attr("data-paged",1);g.attr("data-current-path",d);a("#files-on-qiniu").empty();var c='/<a class="link-Disabled" href="javascript:void(0)" data-file-path="'+d+'" data-file-id="'+b+'">'+j+"</a>",f=a("#wp-qiniu-path-navi");f.find("a.link-Disabled").attr("class","link-Active");f.append(c);g.text("加载更多");g.attr("class","page-navi");g.attr("data-loading","false");g.click()});a('div.file-on-qiniu[data-file-type!="dir"]').live("dblclick",function(i){var h=a(this),f=a("#wp-qiniu-storage-domain").val(),c=h.attr("data-file-type"),g=a("#load-more").attr("data-current-path")+h.attr("data-file-name"),d="",b="";if(c=="image"){if(a("#wp-qiniu-watermark-style").val()){b=a("#wp-qiniu-style-split-char").val()+a("#wp-qiniu-watermark-style").val()}}d=f+encodeURI(g+b);a("#btn-copy").attr("data-clipboard-text",d);new ClipboardJS("#btn-copy");a("#btn-copy").click()});a("#wp-qiniu-path-navi").find("a.link-Active").live("click",function(g){a("#btn-clear").click();var j=a(this),f=j.attr("data-file-id"),c=j.attr("data-file-path"),k=a("#load-more"),b=a("#wp-qiniu-path-navi"),l=b.html();k.attr("data-pid",f);k.attr("data-paged",1);k.attr("data-current-path",c);a("#files-on-qiniu").empty();var d=l.indexOf("</a>",l.indexOf('data-file-id="'+f+'">'));var h=l.substring(0,d+4);b.html(h);b.find("a:last").attr("class","link-Disabled");k.text("加载更多");k.attr("class","page-navi");k.attr("data-loading","false");k.click()});a("#btn-newdir").click(function(){var g=prompt("请输入文件夹的名称（请勿使用特殊字符及系统保留字符）：","新建文件夹");if(g==null){return}if(g.trim(" ")==""){alert("文件夹名不能为空！");return false}var f=a(this),e=true;var h=a('div.file-on-qiniu[data-file-type="dir"]:first');while(h&&h.length&&h.length>0){if(g==h.attr("data-file-name")){alert("已存在相同名称的文件夹！");f.attr("disabled",false);e=false;break}h=h.next('div.file-on-qiniu[data-file-type="dir"]')}if(!e){return}var b=a("#load-more"),d=b.attr("data-pid"),c=b.attr("data-current-path");a.ajax({type:"POST",dataType:"json",url:a("#wp-admin-ajax-url").val(),data:{action:"wp_qiniu_create_floder",pid:d,dirname:g,nonce:a("#wp_qiniu_ajax_nonce").val()},beforeSend:function(){f.attr("disabled",true)},success:function(n,k){if(n.status!="success"){alert("文件夹创建失败！Error："+n.error);return}var i=n.id,j=n.isdir,l=n.fname,p=n.ctime,m=n.mimeType,q="dir",o=a("#wp-qiniu-plugin-url").val();var r='<div class="file-on-qiniu" data-file-name="'+l+'" data-file-type="dir" data-file-id="'+i+'" data-file-mime="'+m+'">';r+='<div class="file-thumbnail">';r+='<img src="'+o+"img/"+q+'.png" />';r+="</div>";r+='<div class="file-name"><div class="file-text">';r+=l;r+="</div></div>";r+="</div>";if(c!=a("#load-more").attr("data-current-path")){return}a("#files-on-qiniu").append(r)},error:function(j,l,k){if(j.responseText){var i=JSON.parse(j.responseText);alert("文件夹创建失败！"+i.error+", "+j.status+": "+k+", status: "+l)}else{alert("文件夹创建失败！"+j.status+": "+k+", status: "+l)}},complete:function(i,j){f.attr("disabled",false)}})});a("#btn-delete").click(function(){var f=confirm("你确定要删除选定的所有文件及文件夹吗？文件删除后将不可恢复！如果文件较多将需要较长时间。");if(f==false){return}var e=a(this),b=a("#load-more").attr("data-pid"),d=new Array(),c=0;a("div.file-on-qiniu.selected").each(function(){var g=a(this).attr("data-file-id");d[c]=g;c++});a.ajax({type:"post",dataType:"json",url:a("#wp-admin-ajax-url").val(),data:{action:"wp_qiniu_delete_files",files:d,nonce:a("#wp_qiniu_ajax_nonce").val()},beforeSend:function(g){e.attr("disabled",true);a("#btn-clear").attr("disabled",true);a("#btn-insert").attr("disabled",true);a("#btn-reload").attr("disabled",true);a("#btn-rename").attr("disabled",true)},success:function(k,m){if(k.status!="success"){alert("删除失败！Error："+k.error);e.attr("disabled",false);return}var l=k.data,j=true,g=a("#files-on-qiniu");for(var h=0;h<l.length;h++){if(b!=a("#load-more").attr("data-pid")){e.attr("disabled",false);return}if(l[h]["result"]){g.find('div.file-on-qiniu[data-file-id="'+l[h]["id"]+'"]').remove()}j&=l[h]["result"]}if(!j){alert("部分文件未能成功删除，如需继续删除，请刷新后再操作。")}else{alert("已成功删除所有选定的文件或文件夹。")}},error:function(h,j,i){if(h.responseText){var g=JSON.parse(h.responseText);alert("删除失败！"+g.error+", "+h.status+": "+i+", status: "+j)}else{alert("删除失败！"+h.status+": "+i+", status: "+j)}},complete:function(h,i){var g=a("div.file-on-qiniu.selected");if(g.length>0){a("#btn-delete").attr("disabled",false);a("#btn-clear").attr("disabled",false)}else{a("#btn-delete").attr("disabled",true);a("#btn-clear").attr("disabled",true)}if(g.length==1){a("#btn-rename").attr("disabled",false)}else{a("#btn-rename").attr("disabled",true)}if(a('div[data-file-type!="dir"].file-on-qiniu.selected').length>0){a("#btn-insert").attr("disabled",false)}else{a("#btn-insert").attr("disabled",true)}a("#btn-reload").attr("disabled",false)}})});a("#btn-rename").click(function(){var f=a("div.file-on-qiniu.selected");var e=f.attr("data-file-name"),c=f.attr("data-file-type"),i=f.attr("data-file-id");var b=prompt("请输入新名称（请勿使用特殊字符及系统保留字符）：",e);if(b==null){return false}if(b.trim(" ")==""){alert("新名称不能为空！");return false}var g=a(this),d=true,h;if(c=="dir"){h=a('div.file-on-qiniu[data-file-type="dir"]:first')}else{h=a('div.file-on-qiniu[data-file-type!="dir"]:first')}while(h&&h.length&&h.length>0){if(b==h.attr("data-file-name")){if(c=="dir"){alert("已存在相同名称的文件夹！")}else{alert("已存在相同名称的文件！")}g.attr("disabled",false);d=false;break}if(c=="dir"){h=h.next('div.file-on-qiniu[data-file-type="dir"]')}else{h=h.next('div.file-on-qiniu[data-file-type!="dir"]')}}if(!d){return}a.ajax({type:"POST",dataType:"json",url:a("#wp-admin-ajax-url").val(),data:{action:"wp_qiniu_file_rename",id:i,newname:b,nonce:a("#wp_qiniu_ajax_nonce").val()},beforeSend:function(){g.attr("disabled",true);a("#btn-reload").attr("disabled",true);a("#btn-insert").attr("disabled",true);a("#btn-delete").attr("disabled",true);a("#show-upload-area").attr("disabled",true)},success:function(j,k){if(j.status!="success"){alert("重命名失败！Error："+j.error);return}f.attr("data-file-name",j.fname);f.find("div.file-text").text(j.fname)},error:function(k,m,l){if(k.responseText){var j=JSON.parse(k.responseText);alert("重命名失败！"+j.error+", "+k.status+": "+l+", status: "+m)}else{alert("重命名失败！"+k.status+": "+l+", status: "+m)}},complete:function(k,l){var j=a("div.file-on-qiniu.selected");if(j.length>0){a("#btn-delete").attr("disabled",false)}else{a("#btn-delete").attr("disabled",true)}if(j.length==1){a("#btn-rename").attr("disabled",false)}else{a("#btn-rename").attr("disabled",true)}if(a('div[data-file-type!="dir"].file-on-qiniu.selected').length>0){a("#btn-insert").attr("disabled",false)}else{a("#btn-insert").attr("disabled",true)}a("#btn-reload").attr("disabled",false);a("#show-upload-area").attr("disabled",false)}})});a("#btn-sync").click(function(){var f=confirm("您确定要同步当前目录下的文件及文件信息吗？");if(f==false){return}a("#btn-clear").click();var e=a(this),d=a("#load-more"),c=d.attr("data-pid"),b=d.attr("timer-int");a("#files-on-qiniu").empty();d.attr("data-paged",1);if(b!="undefined"){clearInterval(b)}a.ajax({type:"POST",dataType:"json",url:a("#wp-admin-ajax-url").val(),data:{action:"wp_qiniu_file_sync",pid:c,nonce:a("#wp_qiniu_ajax_nonce").val()},beforeSend:function(){a("#btn-clear").attr("disabled",true);d.attr("data-loading","true");d.attr("class","page-navi-disable");d.text("正在同步");function g(){var h=d.text();if(h.length<14&&h.length>=4){d.text(h+" .")}else{d.text("正在同步 .")}}b=setInterval(g,1000);d.attr("timer-int",b)},success:function(g,h){clearInterval(b);d.attr("class","page-navi");d.attr("data-loading","false");if(g.status!="success"){d.text("同步失败！  Error："+g.error)}else{alert("同步完成！");d.click()}},error:function(h,j,i){clearInterval(b);d.attr("data-loading","false");d.attr("class","page-navi");if(h.responseText){var g=JSON.parse(h.responseText);d.text("同步失败！"+g.error+", "+h.status+": "+i+", status: "+j)}else{d.text("同步失败！"+h.status+": "+i+", status: "+j)}},complete:function(g,h){d.removeAttr("timer-int")}})})});