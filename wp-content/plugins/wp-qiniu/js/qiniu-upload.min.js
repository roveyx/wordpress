jQuery(function(a){a(document).ready(function(){var s=a("#wp-qiniu-plugin-url").val(),t=a("#wp-qiniu-style-split-char").val(),i=a("#wp-qiniu-thumbnail-style").val(),o=a("#wp-qiniu-watermark-style").val(),h=a("#wp-qiniu-storage-domain").val(),B=a("#wp-admin-ajax-url").val(),d=a("#wp_qiniu_ajax_nonce").val(),u=(i)?t+i:"?imageView2/1/w/100/h/100",b=(o)?t+o:"";var x=4*1024*1024;var e=a("#wp-qiniu-upload-url").val();var c=0;var f=false;var l;var m="";var A={useCdnDomain:true,disableStatisticsReport:false,retryCount:6};var r={fname:"",params:{},mimeType:null};var w=new plupload.Uploader({url:e,runtimes:"html5,flash,html4",browse_button:"upload-pickfiles",container:"upload-container",max_file_size:"512mb",flash_swf_url:"../wp-includes/js/plupload/plupload.flash.swf",max_retries:3,dragdrop:true,drop_element:"upload-pickfiles",chunk_size:x,multi_selection:true,multipart_params:{token:m},init:{PostInit:function(){console.log("upload init")},FilesAdded:function(C,E){f=false;a("#upload-detail").show();a("#upload-success").hide();var F=a("#load-more"),D=F.attr("data-pid"),G=F.attr("data-current-path");plupload.each(E,function(I){I.pid=D;I.path=G;I.overwrite=false;I.canceled=false;var H=new z(I,"fsUploadProgress");H.setStatus("等待...");H.bindUploadCancel(C)})},FileUploaded:function(C,D,E){console.log(E)},UploadComplete:function(C,D){console.log("[完成]")},Error:function(C,D){console.log(D.response)}}});w.init();w.bind("FilesAdded",function(D,C){a("#uploader-ope").show();setTimeout(function(){n(D)},0);D.refresh()});w.bind("Error",function(F,E){console.log("file upload error.");a("#upload-detail").show();var C=new z(E.file,"fsUploadProgress");C.setError();var D=p(E.status);C.setStatus(D);console.log(E.response)});w.bind("BeforeUpload",function(G,F){var D=new z(F,"fsUploadProgress");if(F.canceled){D.fileProgressWrapper.find("td:eq(2) .progressCancel").click();return false}else{if(G.runtime==="html5"&&x){D.setChunkProgess(x)}}F.startTime=new Date();F.speed=F.speed||0;var I=F.id;m=q(G,F);var E=F.key;console.log("file.key",F.key);r.params["x:name"]=E.split(".")[0];var C=function(){var L={};L.token=m;var J=qiniu.filterParams(r.params);for(var M=0;M<J.length;M++){var K=J[M];L[K[0]]=K[1]}L.key=E;G.setOption({url:e,multipart:true,multipart_params:L})};var H=function(){l=x;y(F);if(l===0){v(F);G.stop();return}f=true;var K={};var J=Math.floor(F.loaded/x);var L=qiniu.getHeadersForChunkUpload(m);G.setOption({url:e+"/mkblk/"+l,multipart:false,required_features:"chunks",headers:{Authorization:"UpToken "+m},multipart_params:K})};if((G.runtime==="html5"||G.runtime==="flash")&&x){if(F.size<x){C()}else{H()}}else{console.log("directUpload because file.size < chunk_size || is_android_weixin_or_qq()");C()}});w.bind("ChunkUploaded",function(C,E,H){var D=JSON.parse(H.response);var G=H.total-H.offset;var I=w.getOption&&w.getOption("chunk_size");if(G<I){C.setOption({url:e+"/mkblk/"+G})}C.setOption({headers:{Authorization:"UpToken "+m}});var F=JSON.parse(localStorage.getItem(E.name))||[];F[c]={ctx:D.ctx,time:new Date().getTime(),offset:H.offset,percent:E.percent};c++;localStorage.setItem(E.name,JSON.stringify(F))});w.bind("UploadProgress",function(G,E){var F=(new Date).getTime();var D=F-E.startTime,H=E.loaded||0;f&&(H=E.loaded-E.resumeFilesize);E.speed=(H/D*1000).toFixed(0)||0;var C=new z(E,"fsUploadProgress");C.setProgress(E.percent+"%",E.speed,x)});w.bind("FileUploaded",function(F,D,E){if(f){v(D)}else{var C=a.parseJSON(E.response);g(C,D)}});w.bind("UploadComplete",function(){a("#upload-success").show();a("#uploader-ope").hide()});function n(D){D.start();var C=a("#uploader-ope");C.text("暂停上传");C.css("background-color","yellow");C.css("color","black");C.unbind("click");C.click(function(){k(D)})}function k(D){D.stop();var C=a("#uploader-ope");C.text("继续上传");C.css("background-color","#0085ba");C.css("color","white");C.unbind("click");C.click(function(){n(D)})}function q(E,D){var C="";a.ajax({type:"POST",url:B,async:false,data:{action:"wp_qiniu_get_uptoken",pid:D.pid,fname:D.name,nonce:d},error:function(F){alert("获取文件上传token失败！")},success:function(G){if(G.status==="success"){if(G.exist){var F=confirm("已存在同名文件，覆盖原有文件？");if(F){D.overwrite=true}else{D.canceled=true}}else{D.overwrite=false}C=G.uptoken;D.fname=G.fname;D.key=D.path+D.fname}else{alert(G.error)}}});return C}function g(E,D){localStorage.removeItem(D.name);if(D.overwrite){a('div.file-on-qiniu[data-file-name="'+D.name+'"]').each(function(){if(a(this).attr("data-file-type")!="dir"){a(this).remove()}})}if(E.ncb){E.action="wp_qiniu_upload_complete";E.nonce=d;a.ajax({type:"POST",url:B,async:false,data:E,error:function(F){alert("文件上传成功，但提交文件信息失败！")},success:function(G){if(G.status==="success"){var F=new z(D,"fsUploadProgress");F.setComplete(G)}else{alert(G.error)}}})}else{var C=new z(D,"fsUploadProgress");C.setComplete(E)}}function y(D){var F=JSON.parse(localStorage.getItem(D.name))||[];c=0;var G=F.length;if(G){var H=false;for(var C=0;C<F.length;C++){c++;if(j(F[C].time)){H=true;localStorage.removeItem(D.name);break}}if(H){c=0;return}D.loaded=F[G-1].offset;var E=D.size-D.loaded;if(E<x){l=E}D.percent=F[G-1].percent;D.resumeFilesize=D.loaded;return}else{c=0;D.percent=0;D.resumeFilesize=0}}function v(G){var H=qiniu.createMkFileUrl(e,G.size,G.key,r);var C=[];var J=G.id;var D=localStorage.getItem(G.name);if(D){var F=JSON.parse(D);for(var E=0;E<F.length;E++){C.push(F[E].ctx)}}var I=qiniu.getHeadersForMkFile(m);a.ajax({url:H,type:"POST",headers:I,data:C.join(","),success:function(K){g(K,G)},error:function(M){console.log("file upload error.");a("#upload-detail").show();var K=new z(G,"fsUploadProgress");K.setError();var L=p(M.status);K.setStatus(L);console.log(M.response)}})}function j(D){var C=D+3600*24*1000;return new Date().getTime()>C}function p(C){switch(C){case 298:return"部分操作执行成功。";case 400:return"请求报文格式错误。";case 401:return"认证授权失败。";case 403:return"权限不足，拒绝访问。";case 404:return"资源不存在。";case 405:return"请求方式错误。";case 406:return"上传的数据 CRC32 校验错误。";case 413:return"请求资源大小大于指定的最大值。";case 419:return"用户账号被冻结。";case 478:return"镜像回源失败。";case 502:return"错误网关。";case 503:return"服务端不可用。";case 504:return"服务端操作超时。";case 573:return"单个资源访问频率过高。";case 579:return"上传成功但是回调失败。";case 599:return"服务端操作失败。";case 608:return"资源内容被修改。";case 612:return"指定资源不存在或已被删除。";case 614:return"目标资源已存在。";case 630:return"已创建的空间数量达到上限，无法创建新空间。";case 631:return"指定空间不存在。";case 640:return"调用列举资源(list)接口时，指定非法的marker参数。";case 701:return"在断点续上传过程中，后续上传接收地址不正确或ctx信息已过期。。";default:return"未知错误（错误码："+C+"）。"}}a("#upload-pickfiles").on("dragenter",function(C){C.preventDefault();a("#upload-pickfiles").addClass("draging");C.stopPropagation()}).on("drop",function(C){C.preventDefault();a("#upload-pickfiles").removeClass("draging");C.stopPropagation()}).on("dragleave",function(C){C.preventDefault();a("#upload-pickfiles").removeClass("draging");C.stopPropagation()}).on("dragover",function(C){C.preventDefault();a("#upload-pickfiles").addClass("draging");C.stopPropagation()});a("body").on("click","table button.btn",function(){a(this).parents("tr").next().toggle()});a("#clear-upload-info").click(function(){a("#upload-success").hide();var C=a("#upload-file-detail");C.find("tr.success").remove();C.find("tr.warning").remove();C.find("tr.danger").remove()});a("#uploader-ope").click(function(){n(w)});function z(E,F){this.fileProgressID=E.id;this.file=E;this.opacity=100;this.height=0;this.fileProgressWrapper=a("#"+this.fileProgressID);if(!this.fileProgressWrapper.length){this.fileProgressWrapper=a("<tr></tr>");var O=this.fileProgressWrapper;O.attr("id",this.fileProgressID).addClass("progressContainer");var H=a("<td/>");H.addClass("progressName").text(E.name);var G=plupload.formatSize(E.size).toUpperCase();var I=a("<td/>");I.addClass("progressFileSize").text(G);var M=a("<td colspan='2'/>");var D=a("<div/>");D.addClass("info");var C=a("<div/>");C.addClass("progress progress-striped");var J=a("<div/>");J.addClass("progress-bar progress-bar-info").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%");var K=a('<span class="sr-only" />');K.text(G);var L=a('<a href=javascript:; title="取消上传"><span/></a>');L.show().addClass("progressCancel");J.append(K);C.append(J);D.append(C);D.append(L);var N=a('<div class="status text-center"/>');D.append(N);M.append(D);O.append(H);O.append(I);O.append(M);a("#"+F).append(O)}else{this.reset()}this.height=this.fileProgressWrapper.offset().top;this.setTimer(null)}z.prototype.setTimer=function(C){this.fileProgressWrapper.FP_TIMER=C};z.prototype.getTimer=function(){return this.fileProgressWrapper.FP_TIMER||null};z.prototype.reset=function(){this.fileProgressWrapper.attr("class","progressContainer");this.fileProgressWrapper.find("td .progress .progress-bar-info").attr("aria-valuenow",0).width("0%").find("span").text("");this.appear()};z.prototype.setChunkProgess=function(K){var L=Math.ceil(this.file.size/K);if(L===1){return false}var E=a('<button class="btn btn-default button">查看分块上传进度</button>');var H=a('<tr class="chunk-status-tr"><td colspan=3></td></tr>');var I=a("<div/>");for(var F=1;F<=L;F++){var D=a('<div class="col-md-2"/>');var C=a('<div class="progress progress-striped"></div>');var G=a("<div/>");G.addClass("progress-bar progress-bar-info text-left").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%").attr("id",this.file.id+"_"+F).text("");var J=a("<span/>");J.addClass("chunk-status").text();C.append(G);C.append(J);D.append(C);I.append(D)}if(!this.fileProgressWrapper.find("td:eq(2) .btn-default").length){this.fileProgressWrapper.find("td>div").append(E)}H.hide().find("td").append(I);H.insertAfter(this.fileProgressWrapper)};z.prototype.setProgress=function(R,G,Q){this.fileProgressWrapper.attr("class","progressContainer green");var H=this.file;var D=H.loaded;var S=plupload.formatSize(D).toUpperCase();var N=plupload.formatSize(G).toUpperCase();var J=this.fileProgressWrapper.find("td .progress").find(".progress-bar-info");if(this.fileProgressWrapper.find(".status").text()==="已取消上传"){return}this.fileProgressWrapper.find(".status").text("已上传: "+S+" 上传速度： "+N+"/s");R=parseInt(R,10);if(H.status!==plupload.DONE&&R===100){R=99}J.attr("aria-valuenow",R).css("width",R+"%");if(Q){var P=Math.ceil(H.size/Q);if(P===1){return false}var F=Math.ceil(D/Q);var M,O;for(var K=0;K<F;K++){M=a("#"+H.id+"_"+K);M.width("100%").removeClass().addClass("alert-success").attr("aria-valuenow",100);O="块"+K+"上传进度100%";M.next().html(O)}var I=a("#"+H.id+"_"+F);var L;if(F<P){if(D%Q){L=((D%Q)/Q*100).toFixed(2)}else{L=100;I.removeClass().addClass("alert-success")}}else{var E=H.size-Q*(P-1);var C=H.size-D;if(C%E){L=((D%Q)/E*100).toFixed(2)}else{L=100;I.removeClass().addClass("alert-success")}}I.width(L+"%");I.attr("aria-valuenow",L);O="块"+F+"上传进度"+L+"%";I.next().html(O)}this.appear()};z.prototype.setComplete=function(U){var J=this.fileProgressWrapper.find("td:eq(2)"),L=J.find(".progress");var V=h;var F,P;if(U.url){F=U.url}else{F=V+U.key}P="<div><strong>原文件链接：</strong><a href="+F+" target='_blank' > "+V+U.key+"</a></div><div class=hash><strong>文件Hash值：</strong>"+U.hash+"</div><div class=hash><strong>文件Key：</strong>"+U.key+"</div><br/><div><strong></strong></div>";L.html(P).removeClass().next().next(".status").hide();J.find(".progressCancel").hide();J.find(".btn").parents("tr").next().remove();J.find(".btn").remove();var I=this.fileProgressWrapper.find(".progressName");this.fileProgressWrapper.addClass("success");var T=a('<div class="Wrapper"/>');var O=a('<div class="imgWrapper col-md-3"/>');var K=a('<a class="linkWrapper" target="_blank"/>');var H=a('<img src="'+s+'img/loading.gif"/>');I.append(T);var S=".|jpg|jpeg|png|gif|bmp|",D=".|asf|avi|flv|mkv|mov|mp4|wmv|3gp|3g2|mpeg|ts|rm|rmvb|m3u8|",R=".|ogg|mp3|wma|wav|mp3pro|mid|midi|",E=U.fname.substring(U.fname.lastIndexOf(".")+1).toLowerCase();if(S.indexOf("|"+E+"|")>0){E="image"}else{if(D.indexOf("|"+E+"|")>0){E="video"}else{if(R.indexOf("|"+E+"|")>0){E="audio"}else{E="file"}}}if(E!=="image"&&E!=="video"){H.attr("src",s+"img/"+E+".png");T.addClass("default");O.append(H);T.append(O)}else{if(E==="image"){K.append(H);O.append(K);T.append(O);K.attr("href",F).attr("title","查看原图");H.attr("src",V+encodeURI(U.key)+u)}else{H.attr("src",s+"img/"+E+".png");T.addClass("default");O.append(H);T.append(O)}var N=a('<div class="infoWrapper col-md-6"></div>');if(b&&E==="image"){var M=a('<a href="" target="_blank">查看水印图片</a>');M.attr("href",V+encodeURI(U.key)+b).attr("title","查看水印图片");N.append(M)}var G=a("<div/>");var Q='<div>格式：<span class="origin-format">'+U.format+'</span></div><div>宽度：<span class="orgin-width">'+U.width+'px</span></div><div>高度：<span class="origin-height">'+U.height+"px</span></div>";G.html(Q);N.append(G);T.append(N)}var C='<div class="file-on-qiniu" data-file-name="'+U.fname+'" data-file-type="'+E+'" data-file-id="'+U.id+'" data-file-mime="'+U.mimeType+'">';C+='<div class="file-thumbnail">';if(E==="image"){C+='<img src="'+V+encodeURI(U.key)+u+'" />'}else{C+='<img src="'+s+"img/"+E+'.png" />'}C+="</div>";C+='<div class="file-name"><div class="file-text">';C+=U.fname;C+="</div></div>";C+="</div>";a("#files-on-qiniu").append(C)};z.prototype.setError=function(){this.fileProgressWrapper.find("td:eq(2)").attr("class","text-warning");this.fileProgressWrapper.find("td:eq(2) .progress").css("width",0).hide();this.fileProgressWrapper.find("button").hide();this.fileProgressWrapper.next(".chunk-status-tr").hide();this.fileProgressWrapper.addClass("danger")};z.prototype.setCancelled=function(D){var C="progressContainer";if(!D){C+=" red"}this.fileProgressWrapper.attr("class",C);this.fileProgressWrapper.find("td .progress").remove();this.fileProgressWrapper.find("td:eq(2) .btn-default").hide();this.fileProgressWrapper.find("td:eq(2) .progressCancel").hide();this.fileProgressWrapper.next(".chunk-status-tr").hide()};z.prototype.setStatus=function(D,C){if(!C){this.fileProgressWrapper.find(".status").text(D).attr("class","status text-left")}};z.prototype.bindUploadCancel=function(C){var D=this;if(C){D.fileProgressWrapper.find("td:eq(2) .progressCancel").on("click",function(){D.setCancelled(false);D.setStatus("已取消上传");D.fileProgressWrapper.find(".status").css("left","0");C.removeFile(D.file);D.fileProgressWrapper.addClass("warning");if(C.files.length===0){a("#uploader-ope").hide()}})}};z.prototype.appear=function(){if(this.getTimer()!==null){clearTimeout(this.getTimer());this.setTimer(null)}if(this.fileProgressWrapper[0].filters){try{this.fileProgressWrapper[0].filters.item("DXImageTransform.Microsoft.Alpha").opacity=100}catch(C){this.fileProgressWrapper.css("filter","progid:DXImageTransform.Microsoft.Alpha(opacity=100)")}}else{this.fileProgressWrapper.css("opacity",1)}this.fileProgressWrapper.css("height","");this.height=this.fileProgressWrapper.offset().top;this.opacity=100;this.fileProgressWrapper.show()}})});